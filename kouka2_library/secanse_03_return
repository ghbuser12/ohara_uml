@startuml 図書返却シーケンス図
title 図書返却シーケンス図

actor 事務職員 as Staff
boundary メニュー画面 as Menu
boundary 図書返却画面 as ReturnScreen
control 返却管理 as ReturnCtrl
entity 図書DB as BookDB
entity 貸出DB as LoanDB
entity 履歴DB as HistoryDB
entity 予約DB as ReserveDB
control メール通知サービス as MailService

== 基本フロー ==

Staff -> Menu : 返却メニューを押下①
Menu -> ReturnScreen : 図書返却画面を表示②

Staff -> ReturnScreen : 管理番号を入力・確定③
ReturnScreen -> ReturnCtrl : 返却処理要求(管理番号)
ReturnCtrl -> LoanDB : 貸出情報を検索
LoanDB --> ReturnCtrl : 貸出情報（会員番号・貸出日など）

ReturnCtrl -> BookDB : 図書状態を「在架」に更新
ReturnCtrl -> HistoryDB : 貸出履歴を登録
ReturnCtrl -> ReserveDB : 該当図書の予約情報を検索
alt 予約あり
  ReserveDB --> ReturnCtrl : 予約者情報
  ReturnCtrl -> ReserveDB : 状態を「取置中」に更新
  ReturnCtrl -> MailService : メール通知送信
end

ReturnCtrl --> ReturnScreen : 返却完了メッセージ④

== 代替フロー ==
group 図書が未登録
  ReturnCtrl --> ReturnScreen : 「管理番号が存在しません」
  ReturnScreen --> Staff : メッセージ表示 → 基本③へ
end

group 図書が貸出中でない
  ReturnCtrl --> ReturnScreen : 「この図書は貸出中ではありません」
  ReturnScreen --> Staff : メッセージ表示 → 基本③へ
end

@enduml