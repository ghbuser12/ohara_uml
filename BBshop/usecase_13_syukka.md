# ユースケース名
出荷準備

# ユースケース概要
ユーザーが注文した商品を出荷する前に、クレジットカード決済を行い、決済結果に応じて注文状態を更新し、発送処理を開始するための機能。

# アクター
- 主: ユーザー  
- 関連: クレジットカード会社（外部）、管理者

# 事前条件
- 注文が作成され、支払待ちの状態である。  
- ユーザーが支払方法としてクレジットカードを選択している。

# 事後条件
- 決済が成功した場合、注文は支払済に更新され発送処理が開始される。  
- 決済が失敗した場合、注文は支払未完了のまま処理を停止し、ユーザーへ失敗通知を行う。

# 基本フロー
1. ユーザーはチェックアウト画面でクレジットカード情報を入力し「支払う」を実行する。  
2. システムは金額・注文情報およびカード情報をクレジットカード会社へ送信する。  
3. クレジットカード会社は認証／課金を行い結果（成功／失敗）を返す。  
4. システムは結果を受け取り、成功の場合は決済記録を保存して注文を支払済に更新し、ユーザーへ支払完了通知を送る。  
5. システムは決済成功を管理者・発送サブシステムへ通知し、配送手続きへ移す。

# 代替フロー
- 2a. 外部送信でネットワークエラーが発生した場合: システムは再試行を行い、規定回数失敗したらユーザーへエラー通知を行う。  
- 3a. クレジットカード会社が承認拒否（利用不可・限度超過等）を返した場合: システムは失敗理由をユーザーに表示し、支払方法変更または再試行を促す。  
- 4a. 承認は得られたが課金中にエラーが発生した場合: システムは一時保留状態として管理者通知とログを記録し、ユーザーへ状況を通知する。

# 例外処理
- 二重課金防止: 同一注文に対する複数の決済リクエストは冪等キーで制御する。  
- 返金処理: 返金が必要な場合は別ユースケース（返金）で処理し、返金失敗時はユーザーへ通知して管理者へエスカレーションする。  
- 不正検知: クレジットカード会社またはシステム側で不正が疑われる場合は支払を保留し、管理者が確認するまで発送しない。

# 関連情報
- データ: 決済ID、注文ID、支払方法（クレジットカード）、金額、通貨、決済ステータス、トランザクションID、承認コード、決済日時。  
- 外部連携: クレジットカード会社のAPI（認証、課金、トークン化、Webhook通知）。  
- ビジネスルール:
  - 決済は出荷前に完了していること。  
  - 再試行回数は最大3回。  
  - 二重課金禁止（冪等制御必須）。