# ユースケース名
決済を行う

# ユースケース概要
ユーザは、注文の代金を外部決済サービスを通じて支払う。

# アクター
- 主: ユーザ  
- 関連: 決済代行（外部サービス）、管理者

# 事前条件
- 注文が作成され、支払待ちの状態である。  
- ユーザが支払方法を選択している（クレジットカード、コンビニ決済等）。

# 事後条件
- 決済が成功した場合、注文は支払済に更新され発送処理が開始される。  
- 決済が失敗した場合、注文は支払未完了のまま処理を停止し、ユーザへ失敗通知を行う。

# 基本フロー
1. ユーザはチェックアウト画面で支払方法を選択し「支払う」を実行する。  
2. システムは金額・注文情報を決済代行に送信する（トークン化等を行う場合は併せて実行）。  
3. 決済代行は認証／課金を行い結果（成功／失敗）を返す。  
4. システムは結果を受け取り、成功の場合は決済記録を保存して注文を支払済に更新し、ユーザへ支払完了通知を送る。  
5. システムは決済成功を管理者・発送サブシステムへ通知し、配送手続きへ移す。

# 代替フロー
- 2a. 外部決済への送信でネットワークエラーが発生した場合: システムは再試行を行い、規定回数失敗したらユーザへエラー通知を行う。  
- 3a. 決済代行が承認拒否（利用不可・限度超過等）を返した場合: システムは失敗理由をユーザに表示し、支払方法変更または再試行を促す。  
- 4a. 承認は得られたが課金中にエラーが発生した場合: システムは一時保留状態として管理者通知とログを記録し、ユーザへ状況を通知する。

# 例外処理
- 二重課金防止: 同一注文に対する複数の決済リクエストは冪等キーで制御する。  
- 返金処理: 返金が必要な場合は別ユースケース（返金）で処理し、返金失敗時はユーザへ通知して管理者へエスカレーションする。  
- 不正検知: 決済代行またはシステム側で不正が疑われる場合は支払を保留し、管理者が確認するまで発送しない。

# 関連情報
- データ: 決済ID、注文ID、支払方法、金額、通貨、決済ステータス、トランザクションID、承認コード、決済日時。  
- 外部連携: 決済代行API（認証、課金、トークン化、Webhook通知）。  
- ビジネスルール:
  - 決済は出荷前に完了していること。  
  - 再試行回数は最大3回。  
  - 二重課金禁止（冪等制御必須）。