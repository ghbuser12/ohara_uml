@startuml 予約受付シーケンス図

actor 利用者
participant 図書館システム
participant 予約管理
database 予約データ
participant 図書データ
participant 利用者データ

利用者 -> 図書館システム : 1. 予約画面を開く
activate 図書館システム
図書館システム --> 利用者 : 2. 予約画面表示

利用者 -> 図書館システム : 3. 予約情報(図書管理番号、会員番号)を入力し実行
図書館システム -> 予約管理 : 4. 予約受付要求(管理番号, 会員番号)
activate 予約管理

' --- 予約条件の確認 ---
group 予約条件チェック
    予約管理 -> 図書データ : 4.1. 図書情報照会(管理番号)
    activate 図書データ
    図書データ --> 予約管理 : 4.2. 図書情報
    deactivate 図書データ
    
    予約管理 -> 利用者データ : 4.3. 会員情報照会(会員番号)
    activate 利用者データ
    利用者データ --> 予約管理 : 4.4. 会員情報(貸出数、種別)
    deactivate 利用者データ
    
    note right of 予約管理
      - 貸出上限数(学生6冊/教職員12冊)の確認
      - 図書が貸出中であるかの確認 (貸出中でない場合は予約不要)
    end note
end

alt 予約可能 (図書が貸出中かつ上限に達していない)
    予約管理 -> 予約データ : 5. 予約データ登録(管理番号, 会員番号)
    activate 予約データ
    予約データ --> 予約管理 : 6. 登録完了
    deactivate 予約データ
    
    予約管理 -> 図書館システム : 7. 予約受付完了
    図書館システム --> 利用者 : 8. 「予約を受け付けました」メッセージ表示
else 予約不可 (図書が利用可能 or 貸出上限超過)
    note over 予約管理
      予約不可理由を特定
    end note
    
    alt 図書が貸出中でない場合
        予約管理 -> 図書館システム : 7a. 予約受付不可(図書利用可)
        図書館システム --> 利用者 : 8a. 「図書が利用可能なため予約不要です」メッセージ表示
    else 貸出上限数を超過している場合
        予約管理 -> 図書館システム : 7b. 予約受付不可(上限超過)
        図書館システム --> 利用者 : 8b. 「貸出上限数を超過しています」メッセージ表示
    end
end

deactivate 予約管理
deactivate 図書館システム

@enduml